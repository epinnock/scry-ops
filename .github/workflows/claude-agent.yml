name: Claude Agent

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  claude:
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'claude')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # --- Conditional cross-repo checkouts based on labels ---

      - name: Checkout upload-service
        if: contains(github.event.issue.labels.*.name, 'upload-service')
        uses: actions/checkout@v4
        with:
          repository: epinnock/scry-storybook-upload-service
          token: ${{ secrets.CROSS_REPO_PAT }}
          path: services/scry-storybook-upload-service

      - name: Checkout cdn-service
        if: contains(github.event.issue.labels.*.name, 'cdn-service')
        uses: actions/checkout@v4
        with:
          repository: epinnock/scry-cdn-service
          token: ${{ secrets.CROSS_REPO_PAT }}
          path: services/scry-cdn-service

      - name: Checkout dashboard
        if: contains(github.event.issue.labels.*.name, 'dashboard')
        uses: actions/checkout@v4
        with:
          repository: epinnock/scry-developer-dashboard
          token: ${{ secrets.CROSS_REPO_PAT }}
          path: services/scry-developer-dashboard

      - name: Checkout scry-node
        if: contains(github.event.issue.labels.*.name, 'scry-node')
        uses: actions/checkout@v4
        with:
          repository: epinnock/scry-node
          token: ${{ secrets.CROSS_REPO_PAT }}
          path: services/scry-node

      - name: Checkout sbcov
        if: contains(github.event.issue.labels.*.name, 'sbcov')
        uses: actions/checkout@v4
        with:
          repository: epinnock/scry-sbcov
          token: ${{ secrets.CROSS_REPO_PAT }}
          path: services/scry-sbcov

      - name: Checkout search-api
        if: contains(github.event.issue.labels.*.name, 'search-api')
        uses: actions/checkout@v4
        with:
          repository: epinnock/scry-nextjs
          token: ${{ secrets.CROSS_REPO_PAT }}
          path: services/scry-nextjs

      - name: Checkout landing-page
        if: contains(github.event.issue.labels.*.name, 'landing-page')
        uses: actions/checkout@v4
        with:
          repository: epinnock/scry-landing-page
          token: ${{ secrets.CROSS_REPO_PAT }}
          path: services/scry-landing-page

      - name: Checkout scry-link
        if: contains(github.event.issue.labels.*.name, 'scry-link')
        uses: actions/checkout@v4
        with:
          repository: epinnock/scry-link
          token: ${{ secrets.CROSS_REPO_PAT }}
          path: services/scry-link

      # --- Build --add-dir flags for all checked out services ---

      - name: Build add-dir args
        id: dirs
        run: |
          ARGS=""
          for dir in services/*/; do
            if [ -d "$dir" ]; then
              ARGS="$ARGS --add-dir ${{ github.workspace }}/$dir"
            fi
          done
          echo "add_dirs=$ARGS" >> "$GITHUB_OUTPUT"
          echo "Checked out services: $(ls services/ 2>/dev/null || echo 'none')"

      # --- Run Claude ---

      - uses: anthropics/claude-code-action@v1
        id: claude
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            ${{ steps.dirs.outputs.add_dirs }}
            --max-turns 50
            --model claude-sonnet-4-5-20250929
            --allowedTools "Edit,MultiEdit,Glob,Grep,LS,Read,Write,Bash"

      # --- Push changes back to source repos ---

      - name: Push changes to source repos
        if: success()
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_PAT }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        shell: bash
        run: |
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          declare -A REPO_MAP
          REPO_MAP[scry-storybook-upload-service]="epinnock/scry-storybook-upload-service"
          REPO_MAP[scry-cdn-service]="epinnock/scry-cdn-service"
          REPO_MAP[scry-developer-dashboard]="epinnock/scry-developer-dashboard"
          REPO_MAP[scry-node]="epinnock/scry-node"
          REPO_MAP[scry-sbcov]="epinnock/scry-sbcov"
          REPO_MAP[scry-nextjs]="epinnock/scry-nextjs"
          REPO_MAP[scry-landing-page]="epinnock/scry-landing-page"
          REPO_MAP[scry-link]="epinnock/scry-link"

          PR_LINKS=""

          for dir in services/*/; do
            [ ! -d "$dir" ] && continue
            service_name=$(basename "$dir")
            target_repo="${REPO_MAP[$service_name]}"
            [ -z "$target_repo" ] && continue

            cd "${{ github.workspace }}/$dir"

            if [ -z "$(git status --porcelain)" ]; then
              echo "No changes in $service_name, skipping"
              cd "${{ github.workspace }}"
              continue
            fi

            echo "Changes detected in $service_name, pushing to $target_repo"

            BRANCH="claude/scry-ops-issue-${ISSUE_NUMBER}"

            git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${target_repo}.git"
            git checkout -b "$BRANCH"
            git add -A
            git commit -m "${ISSUE_TITLE} - Automated by scry-ops#${ISSUE_NUMBER}"
            git push origin "$BRANCH"

            PR_URL=$(gh pr create \
              --repo "$target_repo" \
              --head "$BRANCH" \
              --title "${ISSUE_TITLE}" \
              --body "Automated changes from [scry-ops#${ISSUE_NUMBER}](https://github.com/epinnock/scry-ops/issues/${ISSUE_NUMBER}). Generated by Claude Code." \
              2>&1) || true

            echo "Result: $PR_URL"
            PR_LINKS="${PR_LINKS}- **${service_name}**: ${PR_URL}\n"

            cd "${{ github.workspace }}"
          done

          if [ -n "$PR_LINKS" ]; then
            printf "### PRs created in source repos\n\n${PR_LINKS}" | \
              gh issue comment "$ISSUE_NUMBER" --repo epinnock/scry-ops --body-file -
          fi
