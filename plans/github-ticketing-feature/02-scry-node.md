# 02 – scry-node Plan (v2)

This plan describes the implementation work for `scry-node` to support GitHub issue creation from coverage failures.

**Note:** We are implementing v2 directly (GitHub App + fingerprints), skipping v1.

---

## Overview

`scry-node` is primarily a **pass-through** for coverage data generated by `scry-sbcov`. The main responsibilities are:

1. **Ensure coverage reports include fingerprints** (generated by scry-sbcov)
2. **Ensure git context is populated** (commitSha, branch) for issue linking
3. **Compute story transitions** (optional, for auto-close automation)

---

## Story Fingerprint Schema

Fingerprints are generated by `scry-sbcov` and passed through `scry-node`:

```typescript
interface StoryExecutionResult {
  storyId: string;           // "button--primary"
  fingerprint: string;       // "a1b2c3d4e5f67890" (16 hex chars)
  // ... other fields
}

interface StoryFailure {
  storyId: string;
  fingerprint: string;       // "a1b2c3d4e5f67890" (16 hex chars)
  // ... other fields
}
```

### Fingerprint Properties

| Property | Value |
|----------|-------|
| Length | 16 hex characters |
| Algorithm | SHA-256 of `storyFilePath::storyExportName` |
| Stability | Stable unless file path or export name changes |

---

## Implementation Checklist

### Phase 1: Verify Fingerprint Pass-through

- [ ] Verify `lib/coverage.js` passes through fingerprints from scry-sbcov output
- [ ] Verify `extractCoverageSummary()` doesn't strip fingerprint data
- [ ] Add fingerprint to any summary/extract functions if needed

### Phase 2: Git Context (Already Implemented)

Verify these fields are populated in the coverage report:
- [ ] `git.commitSha` – Current commit SHA
- [ ] `git.branch` – Current branch name
- [ ] `git.baseBranch` – Base branch for comparison
- [ ] `git.baseCommitSha` – Base commit SHA

### Phase 3: Story Transitions (Optional)

For auto-close automation, compute story transitions between builds:

```typescript
interface StoryTransition {
  fingerprint: string;
  storyId: string;
  previousStatus: 'passed' | 'failed' | 'unknown';
  currentStatus: 'passed' | 'failed';
  transition: 'fixed' | 'broken' | 'unchanged';
}
```

**Option A: Compute in scry-node (Preferred)**
- [ ] Add `--previous-report` CLI flag
- [ ] Compare fingerprints between reports
- [ ] Emit transitions in output

**Option B: Leave to Dashboard**
- Dashboard fetches previous build's coverage
- Dashboard computes transitions client-side

---

## File Changes Summary

| File | Change |
|------|--------|
| `lib/coverage.js` | **Verify** – Fingerprints pass through |
| `lib/git-context.js` | **Verify** – Git context populated |
| `lib/transitions.js` | **New (Optional)** – Compute transitions |

---

## Dependencies

- **scry-sbcov >= 1.3.0** – Must include fingerprint generation

---

## Acceptance Criteria

1. ✅ Coverage reports include fingerprints for all stories
2. ✅ Git context (commitSha, branch) is populated
3. ✅ No data loss when coverage report passes through
4. ⏳ (Optional) Story transitions can be computed
