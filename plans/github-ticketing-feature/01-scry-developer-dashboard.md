# 01 – scry-developer-dashboard Plan (v2)

This plan describes the implementation work for `scry-developer-dashboard` to support GitHub issue creation from coverage failures.

**Note:** We are implementing v2 directly (GitHub App + fingerprints), skipping v1.

---

## Overview

The dashboard is the primary execution surface for GitHub ticketing:

1. **GitHub App integration** – Installation, token minting, API calls
2. **Issue creation UI** – Story selection, issue modal, metadata pickers
3. **Issue lifecycle** – Linking, auto-close, webhook sync
4. **Firestore persistence** – Issue mappings, installation data

---

## Story Fingerprint Schema

Fingerprints are generated by `scry-sbcov` and consumed by the dashboard:

```typescript
// Fingerprint format: 16 hex characters
// Example: "a1b2c3d4e5f67890"

interface StoryFailure {
  storyId: string;           // "button--primary"
  fingerprint: string;       // "a1b2c3d4e5f67890"
  componentName: string;     // "Button"
  storyName: string;         // "Primary"
}
```

---

## Firestore Schema

### `projects/{projectId}` (Extended)

```typescript
{
  // ... existing fields
  repository: {
    provider: 'github',
    owner: 'acme-corp',
    repo: 'design-system',
    url: 'https://github.com/acme-corp/design-system'
  },
  githubInstallationId: 12345678,
  githubAppConnectedAt: Timestamp,
  githubAppConnectedBy: 'user-id'
}
```

### `projects/{projectId}/issueLinks/{fingerprint}` (New)

```typescript
{
  fingerprint: 'a1b2c3d4e5f67890',
  storyId: 'button--primary',
  componentName: 'Button',
  storyName: 'Primary',
  issueNumber: 42,
  issueUrl: 'https://github.com/acme-corp/design-system/issues/42',
  issueState: 'open' | 'closed',
  createdAt: Timestamp,
  createdBy: 'user-id',
  lastSyncedAt: Timestamp,
  passingSinceBuilds: ['build-id-1', 'build-id-2'],
  autoCloseEligible: boolean
}
```

### `projects/{projectId}/issueDefaults` (New, Optional)

```typescript
{
  defaultLabels: ['storybook', 'visual-regression'],
  defaultAssignees: ['github-username'],
  defaultMilestone: 'v2.0',
  issueTemplate: '## Story Failure\n\n{{storyDetails}}...',
  autoClosePolicy: {
    enabled: true,
    requiredPassingBuilds: 2,
    action: 'close' | 'comment' | 'label'
  }
}
```

### `githubAppInstallations/{installationId}` (New, Global)

```typescript
{
  installationId: 12345678,
  accountType: 'Organization' | 'User',
  accountLogin: 'acme-corp',
  accountId: 98765432,
  projectIds: ['project-id-1', 'project-id-2'],
  installedAt: Timestamp,
  installedBy: 'user-id',
  permissions: { issues: 'write', metadata: 'read' },
  events: ['issues', 'installation']
}
```

---

## Environment Variables

```bash
# GitHub App identity
GITHUB_APP_ID=123456
GITHUB_APP_CLIENT_ID=Iv1.abc123def456
GITHUB_APP_CLIENT_SECRET=secret_abc123
GITHUB_APP_PRIVATE_KEY_BASE64=LS0tLS1CRUdJTi...
GITHUB_WEBHOOK_SECRET=whsec_abc123

# App URLs
GITHUB_APP_INSTALL_URL=https://github.com/apps/scry-storybook/installations/new
GITHUB_APP_CALLBACK_URL=https://dashboard.scry.dev/api/github-app/callback

# Feature flags
ENABLE_GITHUB_TICKETING=true
ENABLE_GITHUB_APP=true
GITHUB_AUTO_CLOSE_REQUIRED_BUILDS=2
```

---

## Implementation Checklist

### Phase 1: Type Changes

- [ ] Extend `lib/types/project.types.ts`:
  - Add `repository?: RepositoryConfig` to `Project`
  - Add `githubInstallationId?: number` to `Project`
- [ ] Create `lib/types/github.types.ts`

### Phase 2: GitHub App Service

- [ ] Create `lib/services/github-app.service.ts`:
  - JWT generation from private key
  - Installation token minting
  - Token caching (10 min TTL)

### Phase 3: API Routes

#### GitHub App Routes
- [ ] `app/api/github-app/install-url/route.ts`
- [ ] `app/api/github-app/callback/route.ts`
- [ ] `app/api/github-app/webhook/route.ts`

#### GitHub API Routes
- [ ] `app/api/github/issues/route.ts`
- [ ] `app/api/github/repos/[owner]/[repo]/labels/route.ts`
- [ ] `app/api/github/repos/[owner]/[repo]/milestones/route.ts`
- [ ] `app/api/github/repos/[owner]/[repo]/collaborators/route.ts`

### Phase 4: UI Components

- [ ] Extend `components/project-detail/ProjectSettings.tsx`
- [ ] Modify `components/coverage/CoverageDashboard.tsx`
- [ ] Create `components/coverage/ComponentRow.tsx`
- [ ] Create `components/coverage/FailedStoryRow.tsx`
- [ ] Create `components/coverage/GitHubIssueModal.tsx`
- [ ] Create `components/coverage/AttachmentUploader.tsx`

### Phase 5: Issue Lifecycle

- [ ] Detect transitions in coverage upload API
- [ ] Create auto-close handler
- [ ] Add lifecycle indicators to UI

### Phase 6: Testing

- [ ] Unit tests for `github-app.service.ts`
- [ ] Unit tests for API routes
- [ ] Integration tests for issue creation
- [ ] E2E test for webhook handling

---

## File Changes Summary

| File | Change |
|------|--------|
| `lib/types/project.types.ts` | **Modify** |
| `lib/types/github.types.ts` | **New** |
| `lib/services/github-app.service.ts` | **New** |
| `app/api/github-app/*` | **New** (3 routes) |
| `app/api/github/*` | **New** (4 routes) |
| `components/project-detail/ProjectSettings.tsx` | **Modify** |
| `components/coverage/CoverageDashboard.tsx` | **Modify** |
| `components/coverage/ComponentRow.tsx` | **New** |
| `components/coverage/FailedStoryRow.tsx` | **New** |
| `components/coverage/GitHubIssueModal.tsx` | **New** |
| `components/coverage/AttachmentUploader.tsx` | **New** |

---

## Acceptance Criteria

1. ✅ Users can connect a GitHub repository via GitHub App
2. ✅ Users can select failed stories and create GitHub issues
3. ✅ Issues are linked to story fingerprints in Firestore
4. ✅ Linked issues are displayed on failed story rows
5. ✅ Webhooks keep issue state in sync
6. ⏳ (Optional) Auto-close when story passes
